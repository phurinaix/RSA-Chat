<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Chat App</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body class="chat">

    <div class="chat__sidebar">
        <h3>People</h3>
        <div id="users"></div>
    </div>

    <div class="chat__main">
        <ol id="messages" class="chat__messages"></ol>

        <div class="chat__footer">
            <form id="message-form">

                <input name="message" type="text" id="myText" placeholder="Message"  autofocus autocomplete="off"/><h1 id="final_span" hidden></h1>



                <button>Send</button>
            </form>

            <button id="send-location">Send location</button>

            <button id="start_button" onclick="startButton(event)">
              <img id="start_img" src="mic.gif" alt="Start"></button>
        </div>

    </div>

    <script id="message-template" type="text/template" >
        <li class="message">
            <div class="message__title">
                <h4>{{from}}</h4>
                <span>{{createdAt}}</span>
            </div>
            <div class="message__body">
                <p>{{text}}</p>


            </div>
        </li>

          <input onclick="responsiveVoice.speak('ข้อความจาก'+'{{from}}'+'พูดว่า'+'{{text}}', 'Thai Male');" type="button" value="Play" />
          <input onclick="responsiveVoice.cancel();" type="button" value="Stop" />

    </script>

    <!-- <script>
           if (!empty({{text}})) {
           responsiveVoice.speak('ข้อความจาก'+'{{from}}'+'พูดว่า'+'{{text}}', 'Thai Male');

         }
     </script> -->

    <script id="location-message-template" type="text/template">
        <li class="message">
            <div class="message__title">
                <h4>{{from}}</h4>
                <span>{{createdAt}}</span>
            </div>
            <div class="message__body">
                <p>
                    <a href="{{url}}" target="_blank">My current location</a>
                </p>
            </div>
        </li>
    </script>




<script src="https://code.responsivevoice.org/responsivevoice.js"></script>

<script> if(responsiveVoice.isPlaying()) {
  console.log("I hope you are listening");
}
</script>

<script>
  //Welcome sound !!
  var msg = new SpeechSynthesisUtterance('สวัสดี, วันนี้ต้องการให้ช่วยอะไร?');
  msg.lang = 'th-TH';
  window.speechSynthesis.speak(msg);
  var final_transcript = '';
  var recognizing = false;
  var ignore_onend;
  if (!('webkitSpeechRecognition' in window)) {
    //if don't have a webkitSpeechRecognition
  } else {
      var recognition = new webkitSpeechRecognition();
      recognition.lang = "th-TH";
      recognition.onstart = function() {
        recognizing = true;
        start_img.src = 'mic-animate.gif';
      };
      recognition.onresult = function(event) {
        console.log(event)
        var interim_transcript = '';
        for (var i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            final_transcript += event.results[i][0].transcript;
          } else {
            interim_transcript += event.results[i][0].transcript;
          }
        }
        final_span.innerHTML = final_transcript;
        document.getElementById("myText").value = final_span.innerHTML;
        speak(final_transcript);
      }
  }
  function startButton(event) {
    if (recognizing) {
      recognition.stop();
      return;
    }
    final_transcript = '';
    recognition.start();
    ignore_onend = false;
    start_img.src = 'mic-slash.gif';
  }
  recognition.onend = function() {
    recognizing = false;
    if (ignore_onend) {
      return;
    }
    start_img.src = 'mic.gif';
  };
  function speak(text) {
    //Hardcode becuz it's a tutorial. Got it?
    var msg_light = 'เปิดไฟหน้าบ้าน';
    var turnoffAllLight = 'ปิดไฟทั้งหมด'
    var whatsup = 'สบายดีไหม';
    var sawasdee = 'สวัสดี';
    //Text to speech
    var speechSynthesis = new SpeechSynthesisUtterance();
    speechSynthesis.voiceURI = 'native';
    speechSynthesis.volume = 1; // 0 to 1
    speechSynthesis.rate = 1; // 0.1 to 10
    speechSynthesis.pitch = 2; //0 to 2
    speechSynthesis.lang = 'th-TH';
    var msg = '';
    //Do whatever you want.
    if(text.search(msg_light) != -1 || text.search(turnoffAllLight) != -1 ) {
      msg = "ทำการ" + text + "เรียบร้อยแล้วค่ะ";
      speechSynthesis.text = msg;
    } else if(text.search(whatsup) != -1) {
      msg = 'สบายดีค่ะ, แล้วคุณหล่ะคะ ';
      speechSynthesis.text = msg;
    } else if(text.search(sawasdee) != -1) {
      msg = 'สวัสดีค่ะ หนีฮ่าว สบายดี ฮัลโหล';
      speechSynthesis.text = msg;
    } else {
      msg = 'คำสั่งดังกล่าวยังไม่มีในฐานข้อมูลค่ะ';
      speechSynthesis.text = msg;
    }
    window.speechSynthesis.speak(speechSynthesis);
    final_result.innerHTML = msg;
  }
</script>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/libs/jquery-3.3.1.min.js"></script>
    <script src="/js/libs/moment.js"></script>
    <script src="/js/libs/mustache.js"></script>
    <script src="/js/libs/deparam.js"></script>
    <script src="/js/chat.js"></script>
</body>
</html>
